name: AI Auto Fixer (Hybrid Mode)

on:
  pull_request:
    types: [labeled] # 오직 라벨이 붙었을 때만 실행! (돈 아끼는 핵심)

jobs:
  fix:
    if: github.event.label.name == 'ai-fix'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 에이더 작동을 위해 전체 히스토리 필요

      - name: Install Tools
        run: |
          pip install aider-chat
          npm install -g @anthropic-ai/claude-code

          - name: Run Hybrid Fix
          env:
            ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
            DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            # 1. 리뷰 데이터 추출
            gh pr view ${{ github.event.pull_request.number }} --comments > reviews.txt
            
            # 2. Claude(머리) 전략 지시 - 무인 모드(-y) 적용
            # 만약 -y도 안 먹으면 그냥 빼고 실행해도 액션 환경에선 돌아갑니다.
            claude "Read reviews.txt. Create 'strategy.md' for aider. 
            STRICT INSTRUCTION: 
            1. Fix all logic issues (NaN, Next Image, etc.).
            2. Add JSDoc comments to EVERY function to satisfy 'Docstring Coverage 80%'. 
            Write the instruction in detail so aider doesn't skip anything." -y

            # 3. Aider(손발) 실행
            # yes | 를 붙여서 모든 질문에 자동으로 '예'라고 답하게 만듭니다.
            yes | aider --model deepseek/deepseek-chat --message-file strategy.md --auto-commit
